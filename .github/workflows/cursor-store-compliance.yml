name: Cursor Store Compliance Check

on:
  push:
    branches: [ main, master ]
    paths:
      - 'server.json'
      - 'README.md'
      - '.github/workflows/cursor-store-compliance.yml'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'server.json'
      - 'README.md'
      - '.github/workflows/cursor-store-compliance.yml'
  workflow_dispatch:

jobs:
  compliance-check:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Validate server.json structure
      id: validate_json
      run: |
        echo "Validating server.json structure..."
        
        if [ ! -f server.json ]; then
          echo "❌ server.json not found"
          exit 1
        fi
        
        # Validate JSON syntax
        if ! jq . server.json > /dev/null 2>&1; then
          echo "❌ server.json is not valid JSON"
          exit 1
        fi
        
        echo "✅ server.json is valid JSON"
        echo "valid_json=true" >> $GITHUB_OUTPUT
    
    - name: Check required fields in server.json
      id: check_fields
      run: |
        echo "Checking required fields in server.json..."
        
        ERRORS=()
        WARNINGS=()
        
        # Required fields according to Cursor Store rules
        REQUIRED_FIELDS=("name" "description" "version" "repository")
        
        for field in "${REQUIRED_FIELDS[@]}"; do
          VALUE=$(jq -r ".${field} // empty" server.json)
          if [ -z "$VALUE" ] || [ "$VALUE" = "null" ]; then
            ERRORS+=("Missing required field: $field")
          else
            echo "✅ Found field: $field = $VALUE"
          fi
        done
        
        # Check repository.url
        REPO_URL=$(jq -r '.repository.url // empty' server.json)
        if [ -z "$REPO_URL" ] || [ "$REPO_URL" = "null" ]; then
          ERRORS+=("Missing required field: repository.url")
        else
          echo "✅ Found repository.url: $REPO_URL"
        fi
        
        # Check for Cursor Store specific fields (may not be in MCP schema)
        PERMISSION_LEVEL=$(jq -r '.permission_level // empty' server.json)
        if [ -z "$PERMISSION_LEVEL" ] || [ "$PERMISSION_LEVEL" = "null" ]; then
          WARNINGS+=("Missing permission_level field (required by Cursor Store rules)")
        else
          if [[ ! "$PERMISSION_LEVEL" =~ ^(low|medium|high)$ ]]; then
            ERRORS+=("Invalid permission_level: $PERMISSION_LEVEL (must be low, medium, or high)")
          else
            echo "✅ Found permission_level: $PERMISSION_LEVEL"
          fi
        fi
        
        # Check category
        CATEGORY=$(jq -r '.category // empty' server.json)
        if [ -z "$CATEGORY" ] || [ "$CATEGORY" = "null" ]; then
          WARNINGS+=("Missing category field (recommended by Cursor Store)")
        else
          echo "✅ Found category: $CATEGORY"
        fi
        
        # Check tags
        TAGS=$(jq -r '.tags // empty' server.json)
        if [ -z "$TAGS" ] || [ "$TAGS" = "null" ] || [ "$TAGS" = "[]" ]; then
          WARNINGS+=("Missing tags field (recommended by Cursor Store)")
        else
          echo "✅ Found tags: $TAGS"
        fi
        
        # Check security_notes
        SECURITY_NOTES=$(jq -r '.security_notes // empty' server.json)
        if [ -z "$SECURITY_NOTES" ] || [ "$SECURITY_NOTES" = "null" ]; then
          if [ "$PERMISSION_LEVEL" = "high" ]; then
            WARNINGS+=("Missing security_notes field (required for high-permission MCPs by Cursor Store)")
          else
            WARNINGS+=("Missing security_notes field (recommended by Cursor Store)")
          fi
        else
          echo "✅ Found security_notes"
        fi
        
        # Check installation instructions
        INSTALL_INSTRUCTIONS=$(jq -r '.packages[0].installation.instructions // empty' server.json)
        if [ -z "$INSTALL_INSTRUCTIONS" ] || [ "$INSTALL_INSTRUCTIONS" = "null" ]; then
          ERRORS+=("Missing installation.instructions field (required by Cursor Store)")
        else
          echo "✅ Found installation.instructions"
        fi
        
        # Check configuration snippet
        CONFIG=$(jq -r '.packages[0].configuration // empty' server.json)
        if [ -z "$CONFIG" ] || [ "$CONFIG" = "null" ]; then
          ERRORS+=("Missing configuration field (required for install snippet by Cursor Store)")
        else
          echo "✅ Found configuration"
        fi
        
        # Output results
        if [ ${#ERRORS[@]} -gt 0 ]; then
          echo "❌ Compliance errors found:"
          for error in "${ERRORS[@]}"; do
            echo "  - $error"
          done
          echo "has_errors=true" >> $GITHUB_OUTPUT
        else
          echo "has_errors=false" >> $GITHUB_OUTPUT
        fi
        
        if [ ${#WARNINGS[@]} -gt 0 ]; then
          echo "⚠️  Compliance warnings:"
          for warning in "${WARNINGS[@]}"; do
            echo "  - $warning"
          done
          echo "has_warnings=true" >> $GITHUB_OUTPUT
        else
          echo "has_warnings=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Validate install snippet
      id: validate_install
      run: |
        echo "Validating install snippet..."
        
        # Extract configuration
        CONFIG=$(jq -r '.packages[0].configuration.mcpServers // empty' server.json)
        
        if [ -z "$CONFIG" ] || [ "$CONFIG" = "null" ]; then
          echo "❌ No configuration found in server.json"
          exit 1
        fi
        
        # Check if configuration is valid JSON
        if ! echo "$CONFIG" | jq . > /dev/null 2>&1; then
          echo "❌ Configuration is not valid JSON"
          exit 1
        fi
        
        # Check for required fields in configuration
        COMMAND=$(echo "$CONFIG" | jq -r 'to_entries[0].value.command // empty')
        if [ -z "$COMMAND" ] || [ "$COMMAND" = "null" ]; then
          echo "❌ Missing 'command' in configuration"
          exit 1
        fi
        
        echo "✅ Install snippet is valid"
        echo "valid_install=true" >> $GITHUB_OUTPUT
    
    - name: Check README quality
      id: check_readme
      run: |
        echo "Checking README quality..."
        
        if [ ! -f README.md ]; then
          echo "❌ README.md not found"
          exit 1
        fi
        
        README_SIZE=$(wc -c < README.md)
        if [ "$README_SIZE" -lt 500 ]; then
          echo "⚠️  README.md is very short (less than 500 characters)"
          echo "has_readme_warnings=true" >> $GITHUB_OUTPUT
        else
          echo "✅ README.md has sufficient content"
          echo "has_readme_warnings=false" >> $GITHUB_OUTPUT
        fi
        
        # Check for required sections
        REQUIRED_SECTIONS=("Installation" "Configuration" "Usage")
        MISSING_SECTIONS=()
        
        for section in "${REQUIRED_SECTIONS[@]}"; do
          if ! grep -qi "^##.*$section" README.md; then
            MISSING_SECTIONS+=("$section")
          fi
        done
        
        if [ ${#MISSING_SECTIONS[@]} -gt 0 ]; then
          echo "⚠️  Missing recommended README sections: ${MISSING_SECTIONS[*]}"
          echo "has_readme_warnings=true" >> $GITHUB_OUTPUT
        else
          echo "✅ README.md contains recommended sections"
        fi
        
        # Check for security information
        if ! grep -qi "security\|safety\|permission" README.md; then
          echo "⚠️  README.md does not mention security considerations"
          echo "has_readme_warnings=true" >> $GITHUB_OUTPUT
        else
          echo "✅ README.md mentions security"
        fi
    
    - name: Check for prohibited content
      id: check_prohibited
      run: |
        echo "Checking for prohibited content..."
        
        PROHIBITED_KEYWORDS=("malware" "backdoor" "exploit" "unauthorized")
        FOUND_PROHIBITED=false
        
        # Check README
        for keyword in "${PROHIBITED_KEYWORDS[@]}"; do
          if grep -qi "$keyword" README.md; then
            echo "⚠️  Found potentially prohibited keyword in README: $keyword"
            FOUND_PROHIBITED=true
          fi
        done
        
        # Check server.json description
        DESCRIPTION=$(jq -r '.description // ""' server.json)
        for keyword in "${PROHIBITED_KEYWORDS[@]}"; do
          if echo "$DESCRIPTION" | grep -qi "$keyword"; then
            echo "⚠️  Found potentially prohibited keyword in description: $keyword"
            FOUND_PROHIBITED=true
          fi
        done
        
        if [ "$FOUND_PROHIBITED" = "true" ]; then
          echo "has_prohibited_warnings=true" >> $GITHUB_OUTPUT
        else
          echo "✅ No prohibited content detected"
          echo "has_prohibited_warnings=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Validate semantic versioning
      id: check_versioning
      run: |
        echo "Validating semantic versioning..."
        
        VERSION=$(jq -r '.version // empty' server.json)
        
        if [ -z "$VERSION" ] || [ "$VERSION" = "null" ]; then
          echo "❌ No version found in server.json"
          exit 1
        fi
        
        # Check if version follows semantic versioning (x.y.z)
        if ! echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+)?$'; then
          echo "⚠️  Version '$VERSION' does not follow semantic versioning (x.y.z)"
          echo "valid_versioning=false" >> $GITHUB_OUTPUT
        else
          echo "✅ Version '$VERSION' follows semantic versioning"
          echo "valid_versioning=true" >> $GITHUB_OUTPUT
        fi
    
    - name: Check license information
      id: check_license
      run: |
        echo "Checking license information..."
        
        LICENSE=$(jq -r '.license // empty' server.json)
        
        if [ -z "$LICENSE" ] || [ "$LICENSE" = "null" ]; then
          echo "⚠️  No license field in server.json"
          echo "has_license=false" >> $GITHUB_OUTPUT
        else
          echo "✅ Found license: $LICENSE"
          echo "has_license=true" >> $GITHUB_OUTPUT
        fi
        
        # Check if LICENSE file exists
        if [ ! -f LICENSE ]; then
          echo "⚠️  No LICENSE file found in repository"
        else
          echo "✅ LICENSE file exists"
        fi
    
    - name: Create compliance report
      if: always()
      run: |
        echo "## Cursor Store Compliance Check Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # JSON validation
        if [ "${{ steps.validate_json.outputs.valid_json }}" = "true" ]; then
          echo "✅ **JSON Structure**: Valid" >> $GITHUB_STEP_SUMMARY
        else
          echo "❌ **JSON Structure**: Invalid" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Required fields
        if [ "${{ steps.check_fields.outputs.has_errors }}" = "true" ]; then
          echo "❌ **Required Fields**: Errors found" >> $GITHUB_STEP_SUMMARY
        else
          echo "✅ **Required Fields**: All present" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ steps.check_fields.outputs.has_warnings }}" = "true" ]; then
          echo "⚠️  **Required Fields**: Warnings (see logs)" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Install snippet
        if [ "${{ steps.validate_install.outputs.valid_install }}" = "true" ]; then
          echo "✅ **Install Snippet**: Valid" >> $GITHUB_STEP_SUMMARY
        else
          echo "❌ **Install Snippet**: Invalid" >> $GITHUB_STEP_SUMMARY
        fi
        
        # README
        if [ "${{ steps.check_readme.outputs.has_readme_warnings }}" = "true" ]; then
          echo "⚠️  **README Quality**: Warnings (see logs)" >> $GITHUB_STEP_SUMMARY
        else
          echo "✅ **README Quality**: Good" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Versioning
        if [ "${{ steps.check_versioning.outputs.valid_versioning }}" = "true" ]; then
          echo "✅ **Semantic Versioning**: Valid" >> $GITHUB_STEP_SUMMARY
        else
          echo "⚠️  **Semantic Versioning**: Invalid format" >> $GITHUB_STEP_SUMMARY
        fi
        
        # License
        if [ "${{ steps.check_license.outputs.has_license }}" = "true" ]; then
          echo "✅ **License**: Present" >> $GITHUB_STEP_SUMMARY
        else
          echo "⚠️  **License**: Missing" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Compliance Status" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.check_fields.outputs.has_errors }}" = "true" ]; then
          echo "❌ **NOT COMPLIANT** - Errors must be fixed" >> $GITHUB_STEP_SUMMARY
          exit 1
        elif [ "${{ steps.validate_install.outputs.valid_install }}" != "true" ]; then
          echo "❌ **NOT COMPLIANT** - Install snippet invalid" >> $GITHUB_STEP_SUMMARY
          exit 1
        else
          echo "✅ **COMPLIANT** - All required checks passed" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check_fields.outputs.has_warnings }}" = "true" ] || [ "${{ steps.check_readme.outputs.has_readme_warnings }}" = "true" ]; then
            echo "⚠️  Some warnings present (recommended improvements)" >> $GITHUB_STEP_SUMMARY
          fi
        fi

